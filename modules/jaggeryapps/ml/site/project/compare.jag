<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML - Machine Learner</title>
    <link href="../../css/bootstrap.css" rel="stylesheet">
    <link href="../../css/custom.css" rel="stylesheet">
    <link href="../../css/custom-theme.css" rel="stylesheet">
    <script src="../../js/respond.min.js"></script>

    <%
        include("../../includes/tenantAware.jag");
        print('<script> var authEncoded = "'+session.get("authEncoded")+'"; </script>');
    %>
    
</head>

<body>

    <div class="container col-lg-12 col-md-12 col-sm-12">

        <!-- header -->
        <header>
            <div class="row wr-global-header">
                <div class="col-sm-8 app-logo">
                    <a href="../home/home.jag"><img src="../../images/logo.png" /><h2 class="app-title">Machine Learner</h2></a>
                </div>
                <div class="col-sm-4">
                    <div class="wr-auth pull-right">
                        <a href="#" data-toggle="dropdown" class="cu-ico-right-button cu-ico-button-user"><% print(session.get("logged.user")); %></a>
                        <div class="dropdown-menu">
                            <div class="cu-arrow"></div>
                            <div class="dropdown-menu-content">
                                <a href="../logout/logout.jag" id="log-out" class="filter-item">Logout</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- /header -->

    <!-- secondary header - app bar -->
    <div id="nav" class="row wr-app-bar">
        <div class="col-md-9 wr-action-container">
            <div class="wr-asset-type-switcher">
                <a href="#" class="ctrl-asset-type-switcher" data-placement="bottom" data-trigger="focus">
                <!--a href="#" class="ctrl-asset-type-switcher" data-placement="bottom" data-trigger="focus"-->
                <span class="btn-asset"></span>
                </a>
            </div>

            <div class="wr-project">
                <span class="title">PROJECTS \ </span><span id="nav-project"></span>
            </div>

            <div class="wr-action-btn-bar">
                <!--a href="#" class="cu-btn btn-add-new">Create Project</a-->
                <!-- <a href="#" class="cu-btn btn-save" id="save-project">Save and Create</a> -->
                <a href="../project/projects.jag" class="cu-btn btn-prev">Back</a>
            </div>            
        </div>

        <div class="col-md-3">
            <div class="wr-secondary-links pull-right">
                <!-- empty -->
                <!-- <a href="../project/projects.jag" id="btn-prev" class="cu-btn btn-prev">Previous</a> -->
                <!-- <a href="#" id="btn-next" class="cu-btn-reverse btn-next">Next</a> -->
            </div>
        </div>
    </div>
    <!-- secondary header - app bar -->


        <!-- content/body -->
        <div class="row">
            <div class="col-lg-12 wr-secondary-bar">

                <!-- Wizard -->
                <!--ul class="nav nav-pills nav-wizard">
        <li class="active"><a href="#" data-toggle="tab"><span class="nav-wedge-step">Step 1</span>Workflow</a><div class="nav-arrow"></div></li>
        <li><div class="nav-wedge"></div><a href="#" data-toggle="tab"><span class="nav-wedge-step">Step 2</span>Data</a><div class="nav-arrow"></div></li>
        <li><div class="nav-wedge"></div><a href="#" data-toggle="tab"><span class="nav-wedge-step">Step 3</span>Algorithm</a><div class="nav-arrow"></div></li>
        <li><div class="nav-wedge"></div><a href="#" data-toggle="tab"><span class="nav-wedge-step">Step 4</span>Parameters</a><div class="nav-arrow"></div></li>
    </ul-->


            </div>
        </div>
        <div class="row">
            <div class="col-md-12">

                <!-- content -->
                <div class="container col-md-12 col-centered wr-content">

                    <h1 class="title">Classification</h1>

                    <div class="panel-group" id="classification-accordion" role="tablist" aria-multiselectable="true">
                        <div id="no-classification" class="ctrl-info-panel col-md-12 col-centered">
                            <h4>You do not have any classification models created at the moment.</h4>
                        </div>
                    </div>

                    <h1 class="title">Numerical Prediction</h1>

                    <div class="panel-group" id="numerical-prediction-accordion" role="tablist" aria-multiselectable="true">
                        <div id="no-numerical-prediction" class="ctrl-info-panel col-md-12 col-centered">
                            <h4>You do not have any numerical prediction models created at the moment.</h4>
                        </div>                    
                    </div>

                    <h1 class="title">Clustering</h1>

                    <div class="panel-group" id="clustering-accordion" role="tablist" aria-multiselectable="true">
                        <div id="no-clustering" class="ctrl-info-panel col-md-12 col-centered">
                            <h4>You do not have any clustering models created at the moment.</h4>
                        </div>                    
                    </div>                    

                </div>
                <!-- /content -->


            </div>
        </div>
        <!-- /content/body -->

    </div>





    <!--footer class="footer">
    <p>&copy; 2014 WSO2 Inc. All Rights Reserved</p>
</footer-->

<div id="content-asset-types" style="display: none">
    <div>
        <a class="ast-type-item" href="../project/projects.jag"><img src="../../images/icons/ico-projects.png" /><span>Projects</span></a>
        <a class="ast-type-item" href="../data/datasets.jag"><img src="../../images/icons/ico-datasets.png" /><span>Datasets</span></a>   
    </div>
</div> 

<script src="../../js/jquery-1.11.1.min.js"></script>
<script src="../../js/wso2.ml.util.js"></script>
<script src="../../js/bootstrap.min.js"></script>

<script type="text/javascript">

    var serverUrl = window.location.origin;

    var projectName = getParameterByName('projectName');
    var projectId = getParameterByName('projectId');
    var datasetId = getParameterByName('datasetId');

    $(document).ready(function() {

        $('#nav').affix({
            offset: {
                top: $('header').height()
            }
        });

        $("[data-toggle=popover]").popover();

        $(".ctrl-asset-type-switcher").popover({
            html : true, 
            content: function() {
                return $('#content-asset-types').html();
            }
        });

        // put path in application navigator
        $('#nav-project').text(projectName);

        loadModels();
    });
    
    function buildNotifications(message){
        if(message == null) {
		return '';
	}
        var builtErrors = 
        '<div class="ctrl-validation-panel-left col-md-12 col-centered">' +
        '<p>' + message + '</p>'
        '</div>';
        return builtErrors;
    }
    // compare function for classification models
    function sortByAccuracy(a, b) {
        var sortStatus = 0;
     
        if (a.modelSummary.modelAccuracy > b.modelSummary.modelAccuracy) {
            sortStatus = -1;
        } else if (a.modelSummary.modelAccuracy < b.modelSummary.modelAccuracy) {
            sortStatus = 1;
        }
        return sortStatus;
    }
    // compare function for numerical prediction models
    function sortByError(a, b) {
        var sortStatus = 0;
     
        if (a.modelSummary.meanSquaredError < b.modelSummary.meanSquaredError) {
            sortStatus = -1;
        } else if (a.modelSummary.meanSquaredError > b.modelSummary.meanSquaredError) {
            sortStatus = 1;
        }
        return sortStatus;
    }
    // function to generate accordion panels
    function createAccordionPanels(models, modelType) {
        var accordionPanels = '';
        for (var i = 0; i < models.length; i++) {
            accordionPanels += '' + 
                '<div class="panel panel-default">' +
                    '<div class="panel-heading" role="tab" id="heading'+i+'">' +
                        '<h4 class="panel-title">' +
                            '<table class="tbl-projects" projectID="' + models[i].id + '">' +
                                '<tr>' +
                                    '<td>' +
                                        '<a data-toggle="collapse" data-parent="#'+modelType+'-accordion" href="#collapse'+i+'" aria-expanded="true" aria-controls="collapse'+i+'" class="ctrl-exp-col">' +
                                            '<span class="cu-acc-head-title">' + models[i].name + '</span>' +
                                            '<span class="cu-acc-head-workflow"></span>' +
                                            '<span class="cu-acc-head-created">[ Algorithm: ' + models[i].modelSummary.algorithm.replace("_", " ") + ' ]</span>';
                                            if(modelType == 'classification') {
                                                accordionPanels += '<span class="cu-acc-head-created">[ Accuracy: <b>' + parseFloat(models[i].modelSummary.modelAccuracy).toFixed(4)*100 + '%</b> ]</span>';
                                            }
                                            else if(modelType == 'numerical-prediction') {
                                                accordionPanels += '<span class="cu-acc-head-created">[ Mean squared error: <b>' + models[i].modelSummary.meanSquaredError + '</b> ]</span>';
                                            }
                                            else if(modelType == 'clustering') {
                                                accordionPanels += '<span class="cu-acc-head-created">[ Comparison not supported ]</span>';
                                            }                                                                                        
                                    accordionPanels += '</a>' +
                                    '</td>' +
                                    '<td class="c-right">' +
                                        '<div>' +
                                            '<a href="#" id="view-model" class="cu-reg-btn btn-view" data-modelname="' + models[i].name + '" data-modelid="' + models[i].id + '" data-analysisid="' + models[i].analysisId + '"><span>View</span></a>' +
                                            '<a href="#" id="predict" class="cu-reg-btn btn-predict" data-modelname="' + models[i].name + '" data-modelid="' + models[i].id + '" data-analysisid="' + models[i].analysisId + '"><span>Predict</span></a>' +
                                        '</div>' +
                                    '</td>' +
                                '</tr>' +
                            '</table>' +
                        '</h4>' +
                    '</div>' +
                    '<div id="collapse'+i+'" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading'+i+'">' +
                        '<div class="panel-body">' + buildNotifications(models[i].error) + '</div>' +
                    '</div>' +
                '</div>';
        };
        return accordionPanels;
    }    
    // function to load models
    function loadModels() {        
        $.ajax({
            type: "GET",
            url: serverUrl+"/api/projects/"+projectId+"/models",
            /*beforeSend : function(xhr) {
                xhr.setRequestHeader("Authorization", "Basic " + authEncoded);
            },*/
            success: function(data) {
                var projectModels = data;
                if (projectModels.length > 0) {

                    var classificationModels = [];
                    var numPredictionModels = [];
                    var clusteringModels = [];

                    for (var i = 0; i < projectModels.length; i++) {
                        if(projectModels[i].modelSummary.algorithm == 'LOGISTIC_REGRESSION' || projectModels[i].modelSummary.algorithm == 'SVM' || projectModels[i].modelSummary.algorithm == 'DECISION_TREE' || projectModels[i].modelSummary.algorithm == 'NAIVE_BAYES') {
                            classificationModels.push(projectModels[i]);
                        }
                        else if(projectModels[i].modelSummary.algorithm == 'LINEAR_REGRESSION' || projectModels[i].modelSummary.algorithm == 'RIDGE_REGRESSION' || projectModels[i].modelSummary.algorithm == 'LASSO_REGRESSION') {
                            numPredictionModels.push(projectModels[i]);
                        }
                        else if(projectModels[i].modelSummary.algorithm == 'K_MEANS') {
                            clusteringModels.push(projectModels[i]);
                        }                        
                    }

                    if (classificationModels.length > 0) {
                        var classificationModelsSorted = classificationModels.sort(sortByAccuracy);
                        var classificationAccordionPanels = createAccordionPanels(classificationModelsSorted, 'classification');
                        $('#no-classification').remove();                              
                        $("#classification-accordion").append(classificationAccordionPanels);                        
                    }

                    if (numPredictionModels.length > 0) {
                        var numPredictionModelsSorted = numPredictionModels.sort(sortByError);
                        var numPredictionAccordionPanels = createAccordionPanels(numPredictionModelsSorted, 'numerical-prediction');
                        $('#no-numerical-prediction').remove();
                        $("#numerical-prediction-accordion").append(numPredictionAccordionPanels);
                    }

                    if (clusteringModels.length > 0) {
                        var clusteringAccordionPanels = createAccordionPanels(clusteringModels, 'clustering');
                        $('#no-clustering').remove();
                        $("#clustering-accordion").append(clusteringAccordionPanels);
                    }                    
                }                
            },
            error: function() {
                var message = "An error occurred while retrieving tenant projects.";
            }
        });

        bindEvents();            
    }
    // function to bind events with elements
    function bindEvents() {

        $(document).on('click', '#predict', function(e){ 
            e.preventDefault();
            
            var modelId = $(this).data('modelid');
            var modelName = $(this).data('modelname');
            var analysisId = $(this).data('analysisid');
            var analysisName = modelName.split(".")[0];
            window.location.href = '../predict/predict.jag?analysisId='+analysisId+'&datasetId='+datasetId+'&modelId='+modelId+'&projectName='+projectName+'&analysisName='+analysisName+'&modelName='+modelName;
        });

        $(document).on('click', '#view-model', function(e){ 
            e.preventDefault();
            
            var modelId = $(this).data('modelid');
            var modelName = $(this).data('modelname');
            var analysisId = $(this).data('analysisid');
            var analysisName = modelName.split(".")[0];
            window.location.href = '../analysis/view-model.jag?analysisId='+analysisId+'&datasetId='+datasetId+'&modelId='+modelId+'&projectName='+projectName+'&analysisName='+analysisName+'&modelName='+modelName;
        });
    }        

</script>

</body>

</html>
